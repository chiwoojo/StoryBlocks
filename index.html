<!doctype html>
<html>

  <head>
    <title>StoryBlocks</title>
    <!-- Google Icon Font -->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Materialize.CSS -->
    <link rel="stylesheet" type="text/css" href="materialize/css/materialize.min.css">
    <!-- Main CSS -->
    <link rel="stylesheet" type="text/css" href="style.css">
    <!-- qtips library CSS - CDN -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/qtip2/2.2.1/basic/jquery.qtip.min.css">
    
    <!-- Let browser know it is optimized for Mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  
  <body>

     <!-- Inside Modal -->
     <div id="modal1" class="modal">
       <div class="modal-content">
         <div class="input-field">
           <input id="u" type="text" class="validate">
           <label for="story-line">Change Username to...</label>
         </div>
       </div>
       <div class="modal-footer">
         <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat" id="username-form">Change</a>
         <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Cancel</a>
       </div>
     </div>
     
    <!-- Messages Collection -->
    <div id="messages"></div>

    <!-- Message input box -->
    <div class="row" id="message-row">
      <form action="" id="message-form" class="col s12">
        <div class="input-field col s8">
          <input id="m" type="text" class="validate">
          <label for="username-change">Continue the story...</label>
        </div>
        <div class="col s4">  
          <!-- Modal Trigger -->
          <a class="waves-effect waves-light btn modal-trigger" href="#modal1">Change User name</a>
        </div>
      </form>
    </div>
    
    

    <!-- Socket IO client library -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <!-- Materialize.JS -->
    <script type="text/javascript" src="materialize/js/materialize.min.js"></script>
    <!-- qtip JS library for tooltips -->
    <script src="https://cdn.jsdelivr.net/qtip2/2.2.1/basic/jquery.qtip.min.js"></script>
    <script>
      var socket = io();
      
      var data = {
        username : '',
        message : ''
      };
      
      //send message
      $('#message-form').submit(function(e) {
        e.preventDefault();
        var message = $('#m').val() + ' ';
        var username = data.username === '' ? 'Anon' : data.username;
        socket.emit('chat message', {message: message, username: username});
        $('#m').val('');
        return false; 
      });
      
      //change user name
      $('#username-form').on('click', function(e) {
        console.log("inside of username-form jQuery click");
        e.preventDefault();
        var username = $('#u').val();
        data.username = username;
        $('#u').val('');
        return false;
      });
      
      //when emit 'chat message' fires from server
      socket.on('chat message', function(data) {
        console.log('Data is ', data);
        var messageDiv = $('<div>')
                           .attr('id', data.uniqueId)
                           .attr('class', 'btn tooltipped')
                           .attr('data-position', "bottom")
                           .attr('data-tooltip', data.username)
                           .attr('data-delay', '50')
                           .text(data.message);
        $('#messages').append(messageDiv);
        $('.tooltipped').tooltip();
        //$('#' + data.uniqueId).qtip();
      });      
      
      $('.modal-trigger').leanModal();
      
    </script>
  </body>
</html>